---
output: 
  pdf_document:
      number_sections: true
      citation_package: natbib 
fontsize: 12pt
geometry: margin=2.5cm
bibliography: references.bib
header-includes:
  - \usepackage{fancyhdr}  # Custom headers/footers
  - \pagestyle{fancy}       # Enable fancy headers/footers
  - \fancyhf{}              # Clear default headers
  - \lfoot{`r Sys.Date()`}    # Left footer: Author name(s)
  - \rfoot{Page \thepage}   # Right footer: Page number
  - \cfoot{Nathann Morand, Felipe Ramirez, Gautier Demierre} # Center footer
  - \thispagestyle{fancy}   # Ensure first page gets the footer too
---

# A1-10, ANOVA Potato

## Introduction
This study investigates the cooking quality of Oregon-grown Russet potatoes. Specifically, it examines how different growing areas, storage conditions, and cooking methods affect the flavor of the potatoes. The `Flavor score` is modeled as a function of:

- **Growing Area**: Southern Oregon vs. Central Oregon
- **Two-week Holding Temperature**: 75°F vs. 40°F
- **Size**: Large vs. Medium
- **Storage Period**: 0, 2, 4, and 6 months
- **Cooking Method**: Boiling, Steaming, Mashing, Baking at 350°F, Baking at 450°F


```{r, echo=FALSE, message=FALSE, warning=FALSE}

# Load required libraries
library(knitr)
library(kableExtra)
library(dplyr)
library(tibble)
library(car)
library(ggplot2)
library(broom)  # For clean ANOVA tables
library(glue)
library(gt)

# Load data
potato <- read.table("potato.dat", header = FALSE)
colnames(potato) <- c("Area", "Temp", "Size", "Storage", "Cooking", "Texture", "Flavor",  "Moistness")
#str(potato)

#sum(is.na(potato))

# Convert categorical variables to factors with meaningful labels
potato$Area <- factor(potato$Area, levels = c(1, 2), labels = c("Southern Oregon", "Central Oregon"))
potato$Temp <- factor(potato$Temp, levels = c(1, 2), labels = c("75°F", "40°F"))
potato$Size <- factor(potato$Size, levels = c(1, 2), labels = c("Large", "Medium"))
potato$Storage <- factor(potato$Storage, levels = c(1, 2, 3, 4), labels = c("0 months", "2 months", "4 months", "6 months"))
potato$Cooking <- factor(potato$Cooking, levels = c(1, 2, 3, 4, 5), labels = c("Boil", "Steam", "Mash", "Bake@350°F", "Bake@450°F"))

```

## Exploratory Data Analysis (EDA)
```{r, echo=FALSE, , message=FALSE, warning=FALSE, fig.align='center', fig.width=5, fig.height=4}

# Split dataset into categorical and numerical subsets
categorical_vars <- potato[, sapply(potato, is.factor)]
numeric_vars <- potato[, c("Texture", "Flavor", "Moistness")]

# Summary table (same code as avant)
summary_numeric <- numeric_vars %>%
  summarise(
    Min = sapply(., min, na.rm = TRUE),
    `1st Quartile` = sapply(., quantile, probs = 0.25, na.rm = TRUE),
    Median = sapply(., median, na.rm = TRUE),
    Mean = sapply(., mean, na.rm = TRUE),
    `3rd Quartile` = sapply(., quantile, probs = 0.75, na.rm = TRUE),
    Max = sapply(., max, na.rm = TRUE)
  )
summary_num_df <- summary_numeric %>%
  t() %>%
  as.data.frame() %>%
  rownames_to_column(var = "Statistic")
colnames(summary_num_df) <- c("Statistic", "Texture", "Flavor", "Moistness")
summary_num_df[, 2:4] <- lapply(summary_num_df[, 2:4], function(x) format(round(as.numeric(x), 2), nsmall = 2))

summary_categorical <- lapply(categorical_vars, summary)
summary_cat_df <- bind_rows(lapply(summary_categorical, function(x) as.data.frame(t(x))), .id = "Variable")
summary_cat_df[is.na(summary_cat_df)] <- ""

kable(summary_cat_df, caption = "Summary Statistics (Categorical Variables)", longtable = TRUE) %>%
  kable_styling(latex_options = c("hold_position", "repeat_header")) %>%
  row_spec(0, angle = 90)

# Boxplot
boxplot(potato$Texture, potato$Flavor, potato$Moistness,
        names = c("Texture", "Flavor", "Moistness"),
        ylab = "Score",
        main = "Distribution of Texture, Flavor, and Moistness Scores",
        col = c("lightblue", "lightgreen", "lightcoral"))
```

The boxplot shows the scores for Texture, Flavor, and Moistness.

- Flavor has the highest median and the scores are quite consistent.

- Moistness has more variation and shows some outliers (small dots below the box).

- Texture has no visible outliers and a moderate spread.

Overall, Flavor is the best-rated and most stable, while Moistness is more variable and sometimes poorly rated.

\newpage
## Mathematical Model

The general form of our ANOVA model is:

\[
\begin{aligned} 
\hat{Y} &= \beta_0 \\  
&+ \beta_1 \cdot \text{Area}_{\text{Central Oregon}} \\  
&+ \beta_2 \cdot \text{Temp}_{40^{\circ}F} \\  
&+ \beta_3 \cdot \text{Size}_{\text{Medium}} \\  
&+ \beta_4 \cdot \text{Storage}_{\text{2 months}} \\  
&+ \beta_5 \cdot \text{Storage}_{\text{4 months}} \\  
&+ \beta_6 \cdot \text{Storage}_{\text{6 months}} \\  
&+ \beta_7 \cdot \text{Cooking}_{\text{Steam}} \\  
&+ \beta_8 \cdot \text{Cooking}_{\text{Mash}} \\  
&+ \beta_9 \cdot \text{Cooking}_{\text{Bake@350}^{\circ}F} \\  
&+ \beta_{10} \cdot \text{Cooking}_{\text{Bake@450}^{\circ}F} \\  
\end{aligned}
\]

where:  
- \( \hat{Y} \) is the predicted **Flavor Score**.  
- \( \beta_i \) are the coefficients associated with the explanatory variables. Each \( i \) refers to a specific level of a categorical factor (excluding the reference level).  
- \( X_i \) are **indicator (dummy) variables** used in ANOVA encoding. For a given categorical variable, the first level is used as a reference, and all other levels are represented by binary variables:  
  \( X_i = 1 \) if the observation belongs to that level, and \( X_i = 0 \) otherwise.  


## Model Assumptions

For the ANOVA model to be valid, the following assumptions must hold:  

- Errors have zero mean: On average, the residuals should be centered around zero.

- Errors are homoscedastic: The residuals should have constant variance across all levels of the predictors (no funnel-shaped patterns).

- Errors are uncorrelated: There should be no systematic patterns or autocorrelation among the residuals.

- Errors are normally distributed: The residuals should approximately follow a normal distribution, especially important for valid hypothesis testing.

## Model Fitting

```{r, echo=FALSE, , message=FALSE, warning=FALSE}
# Fit ANOVA model
anova_model <- aov(Flavor ~ Area + Temp + Size + Storage + Cooking, data = potato)

# Extract ANOVA summary
anova_results <- tidy(anova_model) %>%
  select(term, df, sumsq, meansq, statistic, p.value) %>%
  rename(Term = term, `DF` = df, `Sum Sq` = sumsq, `Mean Sq` = meansq, `F Value` = statistic, `P Value` = p.value) %>%
  mutate(across(where(is.numeric), ~ signif(.x, 2)))  # Round to 2 significant figures

# Display ANOVA table
kable(anova_results, digits = 2, caption = "ANOVA Results for Flavor Score", booktabs = TRUE, longtable = TRUE) %>%
  kable_styling(latex_options = c("hold_position", "repeat_header")) %>%
  row_spec(0, bold = TRUE, background = "lightgray")
```

## Model Selection

We refine our model using stepwise selection based on Akaike’s Information Criterion (AIC). We see that the Size has a very large P value and thus can be removed from the model without compromising its predictive power.

```{r, echo=FALSE , message=FALSE, warning=FALSE}
stepwise_model <- step(anova_model, trace = 0)  # Run stepwise selection quietly

# Extract summary statistics
stepwise_summary <- tidy(stepwise_model)

# Format and display the table
stepwise_summary %>%
  kable(
    format = "latex", 
    digits = 2, 
    caption = "Stepwise Model Summary", 
    longtable = TRUE, 
    booktabs = TRUE  # Remove table lines
  ) %>%
  kable_styling(
    latex_options = c("hold_position", "repeat_header"),
    full_width = FALSE  # Prevent full-width expansion
  ) %>%
  row_spec(0, bold = TRUE, background = "lightgray")  # Rotate column headers to 90°
```

\newpage
## Estimated Model with Numeric Coefficients

The estimated model with numeric values is:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
# Function to escape LaTeX special characters
sanitize_latex <- function(name) {
  name <- gsub("°", "^{\\circ}", name, fixed = TRUE)  # Convert degree symbol
  return(name)
}

# Fit linear model
linear_model <- lm(Flavor ~ Area + Temp + Size + Storage + Cooking, data = potato)

# Extract coefficients
coeffs <- coef(linear_model)
coeff_values <- signif(coeffs, 2)  # Round to 2 significant digits
variable_names <- names(coeffs)[-1]  # Exclude intercept
variable_names <- sapply(variable_names, sanitize_latex)  # Apply sanitization

# Start LaTeX equation
equation_text <- "\\begin{aligned} \\hat{Y} &= "  

# Add intercept (β₀)
equation_text <- paste0(equation_text, signif(coeffs[1], 2), " \\\\ ")  

# Loop through remaining coefficients
for (i in seq_along(variable_names)) {
  sign <- ifelse(coeff_values[i + 1] >= 0, "&+ ", "&- ")  # Align sign
  equation_text <- paste0(equation_text, sign, abs(coeff_values[i + 1]), " \\cdot ", variable_names[i], " \\\\ ")
}

# End equation (no epsilon term)
equation_text <- paste0(equation_text, "\\end{aligned}")

```
$$
`r equation_text`
$$

## Model Diagnostics

To assess whether the ANOVA assumptions hold, we examine residual diagnostics.

```{r, echo=FALSE, , message=FALSE, warning=FALSE}
par(mfrow = c(1, 2))  # Arrange plots in one row

# Q-Q Normal Plot of Residuals
qqnorm(residuals(anova_model), main = "Q-Q Plot of Residuals")
qqline(residuals(anova_model), col = "red")

# Residuals vs Fitted Values
plot(fitted(anova_model), residuals(anova_model),
     main = "Residuals vs Fitted", xlab = "Fitted Values", ylab = "Residuals")
abline(h = 0, col = "red", lty = 2)

```

The Q–Q plot shows that the residuals follow the red line closely, especially in the center. That means the residuals are approximately normally distributed, which supports the normality assumption.

In the residuals vs fitted plot, the points are scattered randomly around zero with no clear pattern. That suggests the variance is roughly constant (homoscedasticity). There's no obvious funnel shape or curve, so the model seems appropriate.

Overall, the residual diagnostics support the assumptions of the ANOVA model.

## Conclusion

This study analyzed the factors influencing the **flavor score** of Oregon-grown Russet potatoes using an **ANOVA model**. The key variables considered included **growing area, storage conditions, size and cooking methods**.  

### **Main Findings**
1. **Significant Factors**
   - **Holding temperature (75°F vs. 40°F)** had the **largest effect** on flavor, with lower temperatures reducing flavor scores.  
   - **Storage duration** influenced flavor, with **2- to 6-month storage improving flavor** compared to fresh potatoes.  
   - **Cooking method** significantly affected flavor, with **boiling and high-temperature baking (450°F) resulting in lower scores**, while **baking at 350°F** yielded better results.  
   - **Growing area (Southern vs. Central Oregon)** also had a **notable impact**.  

2. **Insignificant Factor**
   - **Potato size (Large vs. Medium)** had a very high p-value (\( p = 0.94 \)), indicating **no significant effect on flavor**. It was **removed from the final model** to improve simplicity.  

### **Model Fit & Assumption Verification**
- The **residual analysis** (Q-Q plot and residuals vs. fitted values) indicated that the model **reasonably meets normality and homoscedasticity assumptions**.  
- The estimated residual standard deviation was **0.232**, confirming a **good model fit**.  

### **Interpretation & Implications**
- **Storage at moderate temperatures and baking at 350°F** maximizes potato flavor.  
- **Cold storage (40°F) negatively affects flavor**, which may influence **storage and distribution practices**.  
- **Cooking methods play a crucial role**; steaming and high-temperature baking should be avoided for better flavor retention.  

# References
\renewcommand\refname{}
\renewcommand\bibname{}
\nocite{*}

